###############################################################################################################
###############################################################################################################
##  Calibration Overview:  
##  The steps below result in several files specific to your camera, camera position, actuator hardware, etc:
##  	<your device name>.launch                          The main launch file to make your device available in ROS.
##  	params_camera_<your device name>.yaml              Contains exposure, resolution, & other settings for your camera.
##  	camera_<your device name>.launch                   The launch file for the camera mounted to your experimental device.
##  	calibration_<your device name>.yaml                Parameters describing the relative positions of things.
##  	/cameras/<your device name>_calibration.yaml       Contains distortion & other camera parameters.
##  	/cameras/background.png                            Background image of an empty arena.
###############################################################################################################
###############################################################################################################


0 ############################### Preliminary System Stuff:
# Create calibration directory.
sudo mkdir /cameras
sudo chgrp video cameras/
sudo chmod g+rwx cameras/
groups   # (If "video" isn't listed, then "sudo usermod -a -G video username").


1 ############################### Point to your hardware:
# Determine the name of your experimental hardware, i.e. <your device name>
roscd config
cd launch
# Edit (or create) a .launch file that describes your hardware (see colosseum.launch for an example).
# Edit hardware.launch to point to your .launch file.

# Create device-specific files:
roscd flyatar_calibration/calibration_data/
cp params_camera_NAME.yaml params_camera_<your device name>.yaml        # For example only.  Use your own device name.
cp calibration_NAME.yaml calibration_<your device name>.yaml                # For example only.  Use your own device name.
roscd camera1394v2/launch/
cp camera_NAME.launch camera_<your device name>.launch                      # For example only.  Use your own device's name.
# Edit "camera_<your device name>.launch" to refer to the <camera name> frame.
# Edit "camera_<your device name>.launch" to refer to the "params_camera_<your device name>.yaml" file.
# Edit "params_camera_<your device name>.yaml" to refer to the yet-to-be-created "/cameras/<camera name>_calibration.yaml" file.



2 ############################### Adjust Camera Exposure:
# Start the camera node.
roslaunch camera1394v2 camera_<your device name>.launch &


# Start the camera viewer.  (Might need to "rosmake image_view" first).
rosrun image_view image_view image:=camera/image_raw &   


# Open the camera properties window.
rosrun dynamic_reconfigure reconfigure_gui camera1394v2_node &


# Adjust mode, brightness, exposure, gain, shutter, etc.
# Edit "params_camera_<your device name>.yaml" with the new settings, for example:
#     ~/git/Flyatar2/ros/calibration/flyatar_calibration/calibration_data/params_basler_a622f.yaml
# Close the Dynamic Reconfigure window.


# Kill the camera node.
kill `ps a -o pid,args --no-headers | grep camera1394 | grep CAMERANAME | cut -d ' ' -f 1`


3 ############################### Camera Intrinsic Parameters (i.e. Lens distortion):
rosdep install camera_calibration
rosmake camera_calibration
rosmake image_proc

# Launch the camera node with adjusted settings.
roslaunch camera1394v2 camera_<your device name>.launch &

# Calibrate for distortion.
# Print out ~/git/Flyatar/ros/calibration/flyatar_calibration/patterns/camera_calibration_pattern_30mm.pdf in 1:1 scale
# Measure each checker to make sure it is 30mm, then tape pattern to something flat
# Unmount camera from rig if necessary to give calibration pattern plenty of room to move
rosrun camera_calibration cameracalibrator.py --size 8x6 --square 0.030 image:=/camera/image_raw camera:=/camera

# Wave 30mm checkerboard pattern in front of camera until calibrate button activates
# Click <calibrate> button (will take several minutes)
# Click <commit> button (writes data to /cameras/<your device name>_calibration.yaml)


4 ############################### Camera Extrinsic Parameters (i.e. Relationship of Camera to Arena):
# Mount camera on flyatar rig, positioned so that the arena is roughly centered in image.
roslaunch flyatar_calibration CameraPlate.launch

# Use the following command to move the center and radius of the circle to correspond to the arena.
rostopic pub -1 Joystick/Commands geometry_msgs/Point -- dx dy dr (where dx,dy,dr are replaced with numbers)

# Edit calibration_<your device name>.launch with camera_plate_origin info. 
# Edit camera_<your device name>.launch with mask_radius and camera_plate_origin info. 
# Print ~/git/Flyatar/ros/calibration/flyatar_calibration/patterns/camera_plate_calibration_pattern.pdf in 1:1 scale
# Measure each checker to make sure it is 15mm, then use scissors to cut along circular line surrounding pattern
# Place cicular paper containing the checkerboard pattern on plate
# Edit calibration_<your device name>.launch with rvec and tvec values.
# Ctrl-c to shutdown CameraPlate.launch


5 ############################### Acquire a New Background Image:
# Remove all objects from plate, then:
rm /cameras/background.png
roslaunch tracking tracking.launch


6 ############################### Stage Extrinsic Parameters (i.e. Relationship of Stage to Arena):
# Calibrate the Stage/Plate transform, and get robot image values.
# place magnet on plate, check to see if contour is found properly
# ctrl-c to shutdown track_image_contours_view_images.launch
# reset power on Atmel motorcontroller, wait for motors to home
roslaunch flyatar_calibration StagePlate.launch

# The magnet will drive in a spiral pattern to cover the plate.  After a number of cycles, the calibration values should converge.
# Edit calibration_<your device name>.launch with translation vector and quaternion values.
# Ctrl-c to shutdown StagePlate.launch


